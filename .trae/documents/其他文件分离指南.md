# 其他文件分离指南

## 1. DataCollection.vue 分离指南 (373行)

### 1.1 当前结构分析

**优势：**
- 已经部分组件化，使用了5个子组件
- 主要作为容器组件，协调子组件交互
- 结构相对清晰

**问题：**
- 包含大量事件处理方法（约150行）
- 数据状态管理分散
- 业务逻辑与UI逻辑混合

### 1.2 分离策略

#### 第一阶段：事件处理逻辑分离

**创建文件：** `/web/src/views/data/composables/usePopupManagement.ts`

```typescript
/**
 * 弹窗管理逻辑
 */
import { ref, reactive } from 'vue'
import { ElMessage } from 'element-plus'
import { popupApi } from '@/api/popup'

export function usePopupManagement() {
  const popupsList = ref<any[]>([])
  const popupLoading = ref(false)
  const popupPagination = reactive({
    page: 1,
    size: 10,
    total: 0
  })

  // 加载弹窗列表
  const loadPopups = async () => {
    popupLoading.value = true
    try {
      const response = await popupApi.getPopups({
        page: popupPagination.page,
        page_size: popupPagination.size
      })
      popupsList.value = response.data.data?.items || []
      popupPagination.total = response.data.data?.total || 0
    } catch (error) {
      console.error('加载弹窗列表失败:', error)
      ElMessage.error('加载弹窗列表失败')
    } finally {
      popupLoading.value = false
    }
  }

  // 弹窗事件处理
  const handlePopupSearch = (searchForm: any) => {
    console.log('搜索弹窗:', searchForm)
    loadPopups()
  }

  const resetPopupSearch = () => {
    console.log('重置弹窗搜索')
    loadPopups()
  }

  const batchEnablePopups = (ids: number[]) => {
    console.log('批量启用弹窗:', ids)
    ElMessage.success('批量启用成功')
    loadPopups()
  }

  const batchDisablePopups = (ids: number[]) => {
    console.log('批量禁用弹窗:', ids)
    ElMessage.success('批量禁用成功')
    loadPopups()
  }

  const batchDeletePopups = (ids: number[]) => {
    console.log('批量删除弹窗:', ids)
    ElMessage.success('批量删除成功')
    loadPopups()
  }

  const previewPopup = (popup: any) => {
    console.log('预览弹窗:', popup)
    // 实现预览逻辑
  }

  const editPopup = (popup: any) => {
    return popup // 返回编辑的弹窗数据
  }

  const deletePopup = (popup: any) => {
    console.log('删除弹窗:', popup)
    ElMessage.success('删除成功')
    loadPopups()
  }

  const handlePopupSizeChange = (size: number) => {
    popupPagination.size = size
    loadPopups()
  }

  const handlePopupCurrentChange = (page: number) => {
    popupPagination.page = page
    loadPopups()
  }

  return {
    // 数据
    popupsList,
    popupLoading,
    popupPagination,
    // 方法
    loadPopups,
    handlePopupSearch,
    resetPopupSearch,
    batchEnablePopups,
    batchDisablePopups,
    batchDeletePopups,
    previewPopup,
    editPopup,
    deletePopup,
    handlePopupSizeChange,
    handlePopupCurrentChange
  }
}
```

**创建文件：** `/web/src/views/data/composables/useSubmissionManagement.ts`

```typescript
/**
 * 提交数据管理逻辑
 */
import { ref, reactive } from 'vue'
import { ElMessage } from 'element-plus'
// import { submissionApi } from '@/api/submission'

export function useSubmissionManagement() {
  const submissionsList = ref<any[]>([])
  const submissionLoading = ref(false)
  const submissionPagination = reactive({
    page: 1,
    size: 10,
    total: 0
  })

  // 加载提交数据
  const loadSubmissions = async () => {
    submissionLoading.value = true
    try {
      // 实际实现应该调用提交API
      // const response = await submissionApi.getSubmissionList({
      //   page: submissionPagination.page,
      //   pageSize: submissionPagination.size
      // })
      // submissionsList.value = response.data.data
      // submissionPagination.total = response.data.total
      
      // 临时模拟数据
      submissionsList.value = []
      submissionPagination.total = 0
    } catch (error) {
      console.error('加载提交数据失败:', error)
      ElMessage.error('加载提交数据失败')
    } finally {
      submissionLoading.value = false
    }
  }

  // 提交数据事件处理
  const handleSubmissionSearch = (searchForm: any) => {
    console.log('搜索提交数据:', searchForm)
    loadSubmissions()
  }

  const resetSubmissionSearch = () => {
    console.log('重置提交数据搜索')
    loadSubmissions()
  }

  const exportSubmissions = () => {
    console.log('导出提交数据')
    ElMessage.success('导出功能开发中')
  }

  const batchProcessSubmissions = (ids: number[]) => {
    console.log('批量处理提交数据:', ids)
    ElMessage.success('批量处理成功')
    loadSubmissions()
  }

  const batchDeleteSubmissions = (ids: number[]) => {
    console.log('批量删除提交数据:', ids)
    ElMessage.success('批量删除成功')
    loadSubmissions()
  }

  const viewSubmissionDetail = (submission: any) => {
    return submission // 返回要查看的提交数据
  }

  const updateSubmissionStatus = (submission: any) => {
    console.log('更新提交状态:', submission)
    ElMessage.success('状态更新成功')
    loadSubmissions()
  }

  const deleteSubmission = (submission: any) => {
    console.log('删除提交数据:', submission)
    ElMessage.success('删除成功')
    loadSubmissions()
  }

  const handleSubmissionSizeChange = (size: number) => {
    submissionPagination.size = size
    loadSubmissions()
  }

  const handleSubmissionCurrentChange = (page: number) => {
    submissionPagination.page = page
    loadSubmissions()
  }

  return {
    // 数据
    submissionsList,
    submissionLoading,
    submissionPagination,
    // 方法
    loadSubmissions,
    handleSubmissionSearch,
    resetSubmissionSearch,
    exportSubmissions,
    batchProcessSubmissions,
    batchDeleteSubmissions,
    viewSubmissionDetail,
    updateSubmissionStatus,
    deleteSubmission,
    handleSubmissionSizeChange,
    handleSubmissionCurrentChange
  }
}
```

#### 第二阶段：数据状态管理分离

**创建文件：** `/web/src/views/data/composables/useDataCollectionState.ts`

```typescript
/**
 * 数据收集状态管理
 */
import { ref, reactive, onMounted } from 'vue'

export function useDataCollectionState() {
  const activeTab = ref('popups')
  const showCreatePopupDialog = ref(false)
  const showSubmissionDetailDialog = ref(false)
  const editingPopup = ref(null)
  const selectedSubmission = ref(null)

  // 统计数据
  const stats = reactive({
    totalPopups: 0,
    activePopups: 0,
    totalSubmissions: 0,
    conversionRate: 0
  })

  // 加载统计数据
  const loadStats = async () => {
    try {
      // 实际实现应该调用统计API
      stats.totalPopups = 15
      stats.activePopups = 12
      stats.totalSubmissions = 1247
      stats.conversionRate = 0.245
    } catch (error) {
      console.error('加载统计数据失败:', error)
    }
  }

  // 弹窗表单处理
  const handlePopupSubmit = (formData: any) => {
    console.log('提交弹窗表单:', formData)
    // ElMessage.success(editingPopup.value ? '编辑成功' : '创建成功')
    showCreatePopupDialog.value = false
    resetPopupForm()
    // 需要重新加载弹窗列表
  }

  const resetPopupForm = () => {
    editingPopup.value = null
  }

  return {
    // 状态
    activeTab,
    showCreatePopupDialog,
    showSubmissionDetailDialog,
    editingPopup,
    selectedSubmission,
    stats,
    // 方法
    loadStats,
    handlePopupSubmit,
    resetPopupForm
  }
}
```

### 1.3 修改后的主文件结构

```vue
<template>
  <div class="data-collection">
    <!-- 页面头部 -->
    <div class="page-header">
      <div class="header-left">
        <h1 class="page-title">
          <el-icon><DataAnalysis /></el-icon>
          数据收集
        </h1>
        <p class="page-description">管理弹窗表单和收集的用户数据</p>
      </div>
      <div class="header-right">
        <el-button type="primary" @click="showCreatePopupDialog = true">
          <el-icon><Plus /></el-icon>
          创建弹窗
        </el-button>
        <el-button @click="refreshData">
          <el-icon><Refresh /></el-icon>
          刷新
        </el-button>
      </div>
    </div>

    <!-- 统计卡片 -->
    <DataCollectionStats :stats="stats" />

    <!-- 标签页 -->
    <el-tabs v-model="activeTab" class="main-tabs">
      <!-- 弹窗管理 -->
      <el-tab-pane label="弹窗管理" name="popups">
        <PopupManagement
          :popups-list="popupsList"
          :loading="popupLoading"
          :pagination="popupPagination"
          @search="handlePopupSearch"
          @reset-search="resetPopupSearch"
          @batch-enable="batchEnablePopups"
          @batch-disable="batchDisablePopups" 
          @batch-delete="batchDeletePopups"
          @preview="previewPopup"
          @edit="editPopup"
          @delete="deletePopup"
          @size-change="handlePopupSizeChange"
          @current-change="handlePopupCurrentChange"
        />
      </el-tab-pane>

      <!-- 提交数据 -->
      <el-tab-pane label="提交数据" name="submissions">
        <SubmissionManagement
          :submissions-list="submissionsList"
          :popups-list="popupsList"
          :loading="submissionLoading"
          :pagination="submissionPagination"
          @search="handleSubmissionSearch"
          @reset-search="resetSubmissionSearch"
          @export="exportSubmissions"
          @batch-process="batchProcessSubmissions"
          @batch-delete="batchDeleteSubmissions"
          @view-detail="viewSubmissionDetail"
          @update-status="updateSubmissionStatus"
          @delete="deleteSubmission"
          @size-change="handleSubmissionSizeChange"
          @current-change="handleSubmissionCurrentChange"
        />
      </el-tab-pane>
    </el-tabs>

    <!-- 创建/编辑弹窗对话框 -->
    <PopupFormDialog
      v-model="showCreatePopupDialog"
      :editing-popup="editingPopup"
      @submit="handlePopupSubmit"
      @close="resetPopupForm"
    />

    <!-- 提交详情对话框 -->
    <SubmissionDetailDialog
      v-model="showSubmissionDetailDialog"
      :submission="selectedSubmission"
    />
  </div>
</template>

<script setup lang="ts">
import { onMounted } from 'vue'
import { ElMessage } from 'element-plus'
import { DataAnalysis, Plus, Refresh } from '@element-plus/icons-vue'

// 导入子组件
import DataCollectionStats from './components/DataCollectionStats.vue'
import PopupManagement from './components/PopupManagement.vue'
import SubmissionManagement from './components/SubmissionManagement.vue'
import PopupFormDialog from './components/PopupFormDialog.vue'
import SubmissionDetailDialog from './components/SubmissionDetailDialog.vue'

// 导入组合式函数
import { useDataCollectionState } from './composables/useDataCollectionState'
import { usePopupManagement } from './composables/usePopupManagement'
import { useSubmissionManagement } from './composables/useSubmissionManagement'

// 使用组合式函数
const {
  activeTab,
  showCreatePopupDialog,
  showSubmissionDetailDialog,
  editingPopup,
  selectedSubmission,
  stats,
  loadStats,
  handlePopupSubmit,
  resetPopupForm
} = useDataCollectionState()

const {
  popupsList,
  popupLoading,
  popupPagination,
  loadPopups,
  handlePopupSearch,
  resetPopupSearch,
  batchEnablePopups,
  batchDisablePopups,
  batchDeletePopups,
  previewPopup,
  editPopup,
  deletePopup,
  handlePopupSizeChange,
  handlePopupCurrentChange
} = usePopupManagement()

const {
  submissionsList,
  submissionLoading,
  submissionPagination,
  loadSubmissions,
  handleSubmissionSearch,
  resetSubmissionSearch,
  exportSubmissions,
  batchProcessSubmissions,
  batchDeleteSubmissions,
  viewSubmissionDetail,
  updateSubmissionStatus,
  deleteSubmission,
  handleSubmissionSizeChange,
  handleSubmissionCurrentChange
} = useSubmissionManagement()

// 刷新数据
const refreshData = () => {
  loadStats()
  loadPopups()
  loadSubmissions()
  ElMessage.success('数据已刷新')
}

// 初始化
onMounted(() => {
  loadStats()
  loadPopups()
  loadSubmissions()
})
</script>

<style scoped>
/* 保持原有样式 */
</style>
```

## 2. SystemSettings.vue 分离指南 (338行)

### 2.1 分离策略

#### 第一阶段：系统信息组件分离

**创建文件：** `/web/src/views/settings/components/SystemInfoDialog.vue`

```vue
<template>
  <el-dialog
    v-model="visible"
    title="系统信息"
    width="600px"
    @update:model-value="handleVisibleChange"
  >
    <div class="system-info">
      <el-descriptions :column="2" border>
        <el-descriptions-item label="系统名称">{{ systemInfo.name }}</el-descriptions-item>
        <el-descriptions-item label="系统版本">{{ systemInfo.version }}</el-descriptions-item>
        <el-descriptions-item label="Go版本">{{ systemInfo.go_version }}</el-descriptions-item>
        <el-descriptions-item label="运行时间">{{ systemInfo.uptime }}</el-descriptions-item>
        <el-descriptions-item label="CPU使用率">{{ systemInfo.cpu_usage }}%</el-descriptions-item>
        <el-descriptions-item label="内存使用率">{{ systemInfo.memory_usage }}%</el-descriptions-item>
        <el-descriptions-item label="磁盘使用率">{{ systemInfo.disk_usage }}%</el-descriptions-item>
        <el-descriptions-item label="数据库连接">{{ systemInfo.db_status }}</el-descriptions-item>
      </el-descriptions>
    </div>
  </el-dialog>
</template>

<script setup lang="ts">
import type { SystemInfo } from '@/types/system'

interface Props {
  modelValue: boolean
  systemInfo: SystemInfo
}

interface Emits {
  'update:modelValue': [value: boolean]
}

const props = defineProps<Props>()
const emit = defineEmits<Emits>()

const visible = computed({
  get: () => props.modelValue,
  set: (value) => emit('update:modelValue', value)
})

const handleVisibleChange = (value: boolean) => {
  emit('update:modelValue', value)
}
</script>
```

#### 第二阶段：数据管理逻辑分离

**创建文件：** `/web/src/views/settings/composables/useSystemData.ts`

```typescript
/**
 * 系统数据管理
 */
import { ref } from 'vue'
import { ElMessage } from 'element-plus'
import { getUserList, getRoleList, getPermissionList, getSystemStats } from '@/api/system'
import type { User, Role, Permission, SystemInfo } from '@/types/system'

export function useSystemData() {
  // 数据状态
  const users = ref<User[]>([])
  const roles = ref<Role[]>([])
  const permissions = ref<Permission[]>([])
  const systemInfo = ref<SystemInfo>({} as SystemInfo)

  // 加载状态
  const usersLoading = ref(false)
  const rolesLoading = ref(false)
  const permissionsLoading = ref(false)

  // 数据获取方法
  const fetchUsers = async () => {
    try {
      usersLoading.value = true
      const response = await getUserList({ page: 1, pageSize: 1000 })
      const responseData = response.data as any
      users.value = Array.isArray(responseData) ? responseData : (responseData?.data || [])
    } catch (error) {
      ElMessage.error('获取用户列表失败')
    } finally {
      usersLoading.value = false
    }
  }

  const fetchRoles = async () => {
    try {
      rolesLoading.value = true
      const response = await getRoleList({ page: 1, pageSize: 1000 })
      const responseData = response.data as any
      roles.value = Array.isArray(responseData) ? responseData : (responseData?.data || [])
    } catch (error) {
      ElMessage.error('获取角色列表失败')
    } finally {
      rolesLoading.value = false
    }
  }

  const fetchPermissions = async () => {
    try {
      permissionsLoading.value = true
      const response = await getPermissionList()
      permissions.value = response.data?.data || response.data || []
    } catch (error) {
      ElMessage.error('获取权限列表失败')
    } finally {
      permissionsLoading.value = false
    }
  }

  const fetchSystemInfo = async () => {
    try {
      const response = await getSystemStats()
      systemInfo.value = response.data?.data || response.data || {
        name: '',
        version: '',
        go_version: '',
        build_time: '',
        git_commit: '',
        uptime: '',
        cpu_usage: 0,
        memory_usage: 0,
        memory_total: 0,
        memory_used: 0,
        disk_usage: 0,
        disk_total: 0,
        disk_used: 0,
        db_status: '',
        db_version: '',
        online_users: 0,
        total_users: 0,
        total_roles: 0,
        total_permissions: 0,
        system_load: [],
        network_in: 0,
        network_out: 0
      }
    } catch (error) {
      ElMessage.error('获取系统信息失败')
    }
  }

  return {
    // 数据
    users,
    roles,
    permissions,
    systemInfo,
    // 加载状态
    usersLoading,
    rolesLoading,
    permissionsLoading,
    // 方法
    fetchUsers,
    fetchRoles,
    fetchPermissions,
    fetchSystemInfo
  }
}
```

## 3. Dashboard.vue 分离指南 (323行)

### 3.1 分离策略

**创建文件：** `/web/src/views/dashboard/composables/useDashboardData.ts`

```typescript
/**
 * 仪表盘数据管理
 */
import { ref, reactive } from 'vue'
import { ElMessage } from 'element-plus'
import { dashboardApi } from '@/api/dashboard'

export function useDashboardData() {
  // 响应式数据
  const stats = reactive({
    totalProxies: 0,
    proxyGrowth: 0,
    activeRules: 0,
    rulesGrowth: 0,
    totalTraffic: 0,
    trafficGrowth: 0,
    onlineUsers: 0,
    userChange: 0
  })

  const chartData = reactive({
    trafficData: [],
    proxyStatusData: []
  })

  const recentActivities = ref<any[]>([])
  const systemServices = ref<any[]>([])

  // 加载统计数据
  const loadStats = async () => {
    try {
      // 实际实现应该调用统计API
      // const response = await dashboardApi.getStats()
      
      // 模拟数据
      Object.assign(stats, {
        totalProxies: 42,
        proxyGrowth: 12.5,
        activeRules: 28,
        rulesGrowth: 8.3,
        totalTraffic: 1024 * 1024 * 1024 * 2.5, // 2.5GB
        trafficGrowth: 15.7,
        onlineUsers: 156,
        userChange: -2.1
      })
    } catch (error) {
      console.error('加载统计数据失败:', error)
      ElMessage.error('加载统计数据失败')
    }
  }

  // 加载图表数据
  const loadChartData = async (period: string) => {
    try {
      // 实际实现应该调用图表API
      // const response = await dashboardApi.getChartData(period)
      
      // 模拟流量趋势数据
      const trafficData = []
      const now = new Date()
      for (let i = 23; i >= 0; i--) {
        const time = new Date(now.getTime() - i * 60 * 60 * 1000)
        trafficData.push({
          time: time.getHours() + ':00',
          inbound: Math.random() * 1000000 + 500000,
          outbound: Math.random() * 800000 + 400000
        })
      }
      
      // 模拟代理状态数据
      const proxyStatusData = [
        { value: 25, name: '运行中' },
        { value: 12, name: '空闲' },
        { value: 3, name: '故障' },
        { value: 2, name: '维护中' }
      ]
      
      Object.assign(chartData, {
        trafficData,
        proxyStatusData
      })
    } catch (error) {
      console.error('加载图表数据失败:', error)
      ElMessage.error('加载图表数据失败')
    }
  }

  // 加载活动日志
  const loadActivities = async () => {
    try {
      // 实际实现应该调用活动API
      // const response = await dashboardApi.getActivities()
      
      // 模拟活动数据
      recentActivities.value = [
        {
          id: '1',
          type: 'success',
          title: '新代理服务器上线',
          description: '代理服务器 proxy-001 已成功启动并开始处理请求',
          time: new Date(Date.now() - 5 * 60 * 1000).toISOString()
        },
        {
          id: '2',
          type: 'warning',
          title: '规则匹配率下降',
          description: '路由规则 rule-003 的匹配率在过去1小时内下降了15%',
          time: new Date(Date.now() - 15 * 60 * 1000).toISOString()
        },
        {
          id: '3',
          type: 'info',
          title: '系统维护完成',
          description: '定期系统维护已完成，所有服务恢复正常运行',
          time: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString()
        }
      ]
    } catch (error) {
      console.error('加载活动日志失败:', error)
      ElMessage.error('加载活动日志失败')
    }
  }

  // 加载系统状态
  const loadSystemStatus = async () => {
    try {
      // 实际实现应该调用系统状态API
      // const response = await dashboardApi.getSystemStatus()
      
      // 模拟系统服务数据
      systemServices.value = [
        {
          id: '1',
          name: '代理服务',
          status: 'running',
          uptime: '15天 8小时',
          cpu: 12.5,
          memory: 256
        },
        {
          id: '2',
          name: '数据库服务',
          status: 'running',
          uptime: '30天 12小时',
          cpu: 8.2,
          memory: 512
        },
        {
          id: '3',
          name: '缓存服务',
          status: 'running',
          uptime: '7天 3小时',
          cpu: 3.1,
          memory: 128
        }
      ]
    } catch (error) {
      console.error('加载系统状态失败:', error)
      ElMessage.error('加载系统状态失败')
    }
  }

  // 加载所有仪表盘数据
  const loadDashboardData = async () => {
    await Promise.all([
      loadStats(),
      loadChartData('today'),
      loadActivities(),
      loadSystemStatus()
    ])
  }

  // 更新流量图表周期
  const updateTrafficPeriod = (period: string) => {
    loadChartData(period)
  }

  return {
    // 数据
    stats,
    chartData,
    recentActivities,
    systemServices,
    // 方法
    loadStats,
    loadChartData,
    loadActivities,
    loadSystemStatus,
    loadDashboardData,
    updateTrafficPeriod
  }
}
```

**创建文件：** `/web/src/views/dashboard/composables/useAutoRefresh.ts`

```typescript
/**
 * 自动刷新功能
 */
import { ref, onMounted, onUnmounted } from 'vue'

export function useAutoRefresh(refreshCallback: () => void, interval: number = 30000) {
  let refreshTimer: NodeJS.Timeout | null = null
  const isAutoRefresh = ref(true)

  // 开始自动刷新
  const startAutoRefresh = () => {
    if (refreshTimer) {
      clearInterval(refreshTimer)
    }
    refreshTimer = setInterval(() => {
      if (isAutoRefresh.value) {
        refreshCallback()
      }
    }, interval)
  }

  // 停止自动刷新
  const stopAutoRefresh = () => {
    if (refreshTimer) {
      clearInterval(refreshTimer)
      refreshTimer = null
    }
  }

  // 切换自动刷新
  const toggleAutoRefresh = () => {
    isAutoRefresh.value = !isAutoRefresh.value
    if (isAutoRefresh.value) {
      startAutoRefresh()
    } else {
      stopAutoRefresh()
    }
  }

  onMounted(() => {
    startAutoRefresh()
  })

  onUnmounted(() => {
    stopAutoRefresh()
  })

  return {
    isAutoRefresh,
    startAutoRefresh,
    stopAutoRefresh,
    toggleAutoRefresh
  }
}
```

## 4. 总结

### 4.1 分离效果预期

| 文件 | 原始行数 | 分离后行数 | 减少比例 |
|------|----------|------------|----------|
| ProxyManagement.vue | 809行 | ~200行 | 75% |
| DataCollection.vue | 373行 | ~150行 | 60% |
| SystemSettings.vue | 338行 | ~180行 | 47% |
| Dashboard.vue | 323行 | ~150行 | 54% |

### 4.2 分离收益

1. **代码可维护性提升**：每个文件职责更单一，便于理解和修改
2. **复用性增强**：工具函数和组合式函数可在其他地方复用
3. **测试友好**：独立的函数和组件更容易进行单元测试
4. **协作效率**：减少代码冲突，提高多人协作效率
5. **性能优化**：按需加载，减少初始包大小

### 4.3 实施注意事项

1. **渐进式实施**：一次只分离一个文件，确保每步都稳定
2. **保持接口一致**：分离后的组件和函数接口要与原有逻辑完全一致
3. **充分测试**：每次分离后都要进行完整的功能测试
4. **文档更新**：及时更新相关的开发文档和注释
5. **团队沟通**：确保团队成员了解新的文件结构和使用方式

---

*请严格按照此指南执行分离操作，确保系统稳定性和功能完整性。*